#{extends 'main.html' /}
#{set title:'Home' /}

<script>
    var krest = new Image(94, 94);
    krest.src = '/public/images/krest.png';
    var zero = new Image(94, 94);
    zero.src = '/public/images/null.png';
    var dummy = new Image(94, 94);
    dummy.src = '/public/images/empty.png';

    $(function () {
                var codeEditor = document.getElementById("code-editor");
                var codeMirror = CodeMirror.fromTextArea(codeEditor, {
                    value:"function",
                    theme:"lesser-dark",
                    indentUnit:"3",
                    lineNumbers: true,
                    dragDrop: false,
                    lineWrapping: true
                });
                var logWriter = document.getElementById("log-writer");
                var logMirror = CodeMirror.fromTextArea(logWriter, {
                    value:"function",
                    theme:"lesser-dark",
                    indentUnit:"3",
                    dragDrop:"false",
                    readOnly:"true"
                });

                //myCodeMirror.doc.getValue()
                //myCodeMirror.doc.setValue("hello")

                var botId;
                $("#play-button").click(function () {
                    $.ajax({
                        type: "POST",
                        url: "@@{Application.prepareGame()}",
                        data: {
                            "bot.id": botId,
                            "bot.name": $("#bot-name").val(),
                            sourceCode: codeMirror.doc.getValue()
                        }
                    }).done(function (id) {
                        var socket = new WebSocket("@@{Games.ticTacToe}");
                        botId = id;

                        socket.onmessage = function (event) {
                            var incomingMessage = event.data;
                            showMessage(incomingMessage);
                        };

                        socket.onopen = function () {
                            socket.send(id);
                            socket.send($("input[name=rivalId]:checked").val());
                        };

                        function showMessage(message) {
                            var object = JSON.parse(message);
                            var field = object.field;
                            var table = $("#game-pole")[0];
                            for (var i = 0; i < field.length; i++) {
                                for (var j = 0; j < field[i].length; j++) {
                                    var myImage = new Image(94, 94);
                                    if (field[i][j] == '-') {
                                        myImage.src = '/public/images/empty.png';
                                    } else if (field[i][j] == 'o') {
                                        myImage.src = '/public/images/null.png';
                                    } else {
                                        myImage.src = '/public/images/krest.png';
                                    }
                                    $(table.rows[i].cells[j]).empty();
                                    table.rows[i].cells[j].appendChild(myImage);
                                }
                            }
                            logMirror.doc.setValue(object.firstLog);
                            if (object.state == 'WIN') {
                                $('.result').html(object.message + object.winner);
                            } else {
                                if (object.state != 'PLAY') {
                                    $('.result').html(object.message);
                                }
                            }
                        }
                    }).fail(function (e) {
                        $('.result').html(e.error);
                    });
                });


            }
    );

</script>
<div id="content">
    <div id="leftColumn">
        <div class="left" id="cod">
            <label class="text">Bot name: </label><input type="text" name="bot-name" id="bot-name"/><br/>
            <label class="text">Bot code:</label>
            <textarea class="cod" id="code-editor"></textarea><br/>
            <button id="play-button">Play</button>
        </div>
        <div id="field">
            <table id="game-pole">
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
        </div>
        <div style=" width:100%;clear:both;"></div>
        <div id="gameLog"><textarea class="log" id="log-writer"></textarea></div>
    </div>
    <div id="rightColumn">
        <div id="avatar">*{для примера}*
            <img src="/public/images/avatar/ava2.png" class="avatar"><br/>
            <div id="rivals-block">#{bots bots: rivals, as: 'rivalId'/}</div>
    </div>
 </div>
    <div style=" width:100%;clear:both;"></div>
</div>